# MQTT 与 COAP

## 1. MQTT简介

MQTT是基于二进制消息的发布/订阅编程模式的消息协议

### 1.1 设计原则
1. 精简，不添加可有可无的功能；
2. 发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；
3. 允许用户动态创建主题，零运维成本；
4. 把传输量降到最低以提高传输效率；
5. 把低带宽、高延迟、不稳定的网络等因素考虑在内；
6. 支持连续的会话控制；
7. 理解客户端计算能力可能很低；
8. 提供服务质量管理；
9. 假设数据不可知，不强求传输数据的类型与格式，保持灵活性；

### 1.2 协议特性
- **发布/订阅模式**
  发布/订阅模式解耦了发布消息的客户（发布者）与订阅消息的客户（订阅者）之间的关系，这意味着发布者和订阅者之间并不需要直接建立联系；是一个典型的异步发布/订阅的场景；
  - 发布者与订阅者不必了解彼此，只要认识同一个消息代理即可
  - 发布者和订阅者不需要交互，发布者无需等待订阅者确认而导致锁定
  - 发布者和订阅者不需要同时在线，可以自由选择时间来消费消息

- **主题**
MQTT是通过主题对消息进行分类的，本质上就是一个UTF-8的字符串，不过可以通过反斜杠表示多个层级关系

- **基于TCP/IP**
MQTT工作于应用层，是基于TCP/IP之上的可靠连接，当然也有UDP版本叫做“MQTT-SN”，通常使用的都是TCP版

- **轻量级**
MQTT的报文头部只有2字节，它一开始就假设了客户端是计算能力低需要节省资源的设备，用约定好的二进制位来传递控制消息，省电省流量

- **消息发布服务质量**
**【QoS0】最多一次，不管成功与否**
这是最省电但最不可靠的方式，完全依赖底层TCP/IP网络，可能会发生消息丢失和重复。通常应用于物联网设备上报最新数据，例如温度传感器不断地上传最新温度，这次的数据丢了马上又会有下一次，所以丢失无所谓；由于只是修改状态，具有幂等性，无论重复传输多少次，结果都是一样的，所以重复也无所谓。
**【QoS1】至少一次，保证消息到达，可能重复**
在QoS0之上保证了消息一定会送到，重复无所谓（通常重复的概率很低），但必须要让消费者看见这条消息，这是最常用的服务质量，应用于手机推送消息等各项服务的数据生产消费。假设你的温度传感器监控到温度异常可能着火了，手机APP收到多条着火消息和一条着火消息都收不到，当然是收到多条着火消息更好了。
**【QoS2】只有一次，保证消息只到达一次**
这种当然是最好的情况，但这也是最费电、流程最复杂的情况，大部分物联网大厂都不支持QoS2，因为根本没有这种需求。通常QoS2用于支付，如果支付的数据丢失、或者多次重复支付，都是很难容忍的。或者用于手机聊天消息，手机APP只能接收到一条聊天消息推送，消息的丢失和重复都是不可以的，这种场景直接用HTTP服务器就好了啊，大家都是强大的手机又不是低功耗嵌入式设备。

- **心跳机制**
MQTT维护了双工长连接，通过心跳机制来判断是否掉线。不要担心心跳机制给嵌入式设备带来的负担，通常这个心跳间隔都设置得很长，例如60秒

- **MQTT的保留消息**
MQTT设置了一个保留消息（Retain Message），这是基于主题的，每个主题可以有一条保留消息，如果有新的订阅者订阅了该主题，就需要将这条保留消息推送给它，通常用于新订阅主题的设备初始化

- **MQTT的遗嘱**
MQTT设置了一个遗嘱消息（Will Message），这是基于客户端的，每个客户端在连接的时候可以保留一条遗嘱消息，当连接异常断开（例如网络中断、客户端崩溃、心跳信息没有发送）没有发送正常的DISCONNECT报文的时候，会将这条消息分发给订阅了这个遗嘱消息的客户端，其他客户端就知道它发生问题了，从而做相应的处理，通常用于设备的异常通知，例如当设备正常退出，手机APP需要显示设备正常退出，当设备异常退出，手机APP需要报警，那么手机APP只需要订阅设备的遗嘱消息，就能够知道它断开时是正常的还是异常的了

## 2. MQTT与TCP
[MQTT比TCP协议好在哪儿？](https://www.zhihu.com/question/23373904/answer/636518156)
[为什么用MQTT不用TCP长连接透传](http://www.bewindoweb.com/266.html)
**其实，同类应用的很多问题，都是有一定共性的。这时候就会有一些人提出一般性的解决方式，这样大家就不用重复造轮子，同时又保证了互操作性。这就是协议存在的意义啦**。所以一句话总结，MQTT 和其他的应用层协议，比如 HTPP, FTP, BitTorrent 协议一样，都是**为了解决特定问题而生的一套方案**，可以帮我们省好多事

## 3. COAP简介

CoAP是受限制的应用协议(Constrained Application Protocol)的代名词。由于目前物联网中的很多设备都是资源受限型的，所以只有少量的内存空间和有限的计算能力，传统的HTTP协议在物联网应用中就会显得过于庞大而不适用。因此，IETF的CoRE工作组提出了**一种基于REST架构、传输层为UDP的CoAP协议**

**CoAP采用与HTTP协议相同的请求响应工作模式**。CoAP协议共有4中不同的消息类型。

- CON，需要被确认的请求，如果CON请求被发送，那么对方必须做出响应。
- NON，不需要被确认的请求，如果NON请求被发送，那么对方不必做出回应。
- ACK，应答消息，接受到CON消息的响应。
- RST，复位消息，当接收者接受到的消息包含一个错误，接受者解析消息或者不再关心发送者发送的内容，那么复位消息将会被发送。

**CoAP消息格式使用简单的二进制格式，最小为4个字节**。

**一个消息=固定长度的头部header + 可选个数的option + 负载payload。Payload的长度根据数据报长度来计算**

**CoAP基本上就是一个在Server和Client之间传递状态信息的单对单协议**

## 4. MQTT与COAP

- MQTT协议不支持带有类型或者其它帮助Clients理解的标签信息，也就是说所有MQTT Clients必须要知道消息格式。而CoAP协议则相反，因为CoAP内置发现支持和内容协商，这样便能允许设备相互窥测以找到数据交换的方式。
- MQTT是长连接而CoAP是无连接。MQTT Clients与Broker之间保持TCP长连接，这种情形在NAT环境中也不会产生问题。如果在NAT环境下使用CoAP的话，那就需要采取一些NAT穿透性手段
- MQTT是多个客户端通过中央代理进行消息传递的多对多协议。它主要通过让客户端发布消息、代理决定消息路由和复制来解耦消费者和生产者。MQTT就是相当于消息传递的实时通讯总线。CoAP基本上就是一个在Server和Client之间传递状态信息的单对单协议
- **CoAP主要用于局域网，适用于对于设备需要快速交流的本地网络环境**；由于UDP允许广播和多播，您可以使用较少的带宽潜在地传输到多个主机，这在一些资源有限的环境中是有用的。
- **MQTT主要用于广域网（WAN，互联网），在广域网上的设备之间的通信的理想选择**。它在带宽有限的情况下是最有用的，有云架构的，最好用MQTT完成。
- COAP在反向控制和NAT网络环境下，表现都不算好

## 5. 杂项

物联网的传输方向：物联网中，我们会有“正向”和“反向”两个数据传输方向。 **正向**：终端设备发送数据给服务器，也叫上行。例如一个温度传感器向服务器上报温度数据。 **反向**：服务器给终端设备发控制命令，也叫下行。例如通过服务器给智能窗帘下发“关窗帘”的指令

## 参考文献
[物联网、MQTT协议和MQTT Broker](http://www.bewindoweb.com/242.html)
[MQTT入门篇](http://dataguild.org/?p=6817)
[IOT通讯协议CoAP与MQTT简介](http://www.xmamiga.com/364/)
[MQTT和CoAP哪个最可能成为未来物联网通信标准协议？](https://www.zhihu.com/question/34767514)

